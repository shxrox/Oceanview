<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Room Availability</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f6f7; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-x: auto; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .legend { display: flex; gap: 20px; font-weight: bold; font-size: 14px; margin-bottom: 10px; }
        .dot { width: 15px; height: 15px; display: inline-block; border-radius: 3px; vertical-align: middle; margin-right: 5px; }

        /* THE TABLE */
        table { border-collapse: collapse; width: 100%; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 0; text-align: center; height: 35px; min-width: 30px; }

        /* Header Row (Days) */
        th { background: #2c3e50; color: white; position: sticky; top: 0; z-index: 10; }

        /* First Column (Room Names) */
        .room-col {
            background: #ecf0f1;
            font-weight: bold;
            text-align: left;
            padding: 0 10px;
            min-width: 120px;
            position: sticky;
            left: 0;
            border-right: 2px solid #bdc3c7;
            z-index: 5;
        }

        /* STATUS COLORS */
        .free { background-color: #eafaf1; } /* Light Green */
        .booked { background-color: #e74c3c; cursor: pointer; color: white; font-size: 10px; } /* Red */
        .weekend { background-color: #fef9e7; } /* Light Yellow (Weekend Guide) */

        .booked:hover { opacity: 0.8; }

        /* Room Type Section Header */
        .type-header { background: #3498db; color: white; font-weight: bold; text-align: left; padding-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <a href="receptionist_dashboard.html" style="text-decoration:none; color:#7f8c8d; font-weight:bold;">&larr; Dashboard</a>
            <h2 style="display:inline; margin-left: 15px; color: #2c3e50;">Availability Calendar</h2>
        </div>

        <div>
            <select id="monthSelect" onchange="renderCalendar()"></select>
            <select id="yearSelect" onchange="renderCalendar()"></select>
        </div>
    </div>

    <div class="legend">
        <span><span class="dot" style="background:#eafaf1; border:1px solid #ccc;"></span>Available</span>
        <span><span class="dot" style="background:#e74c3c;"></span>Occupied</span>
    </div>

    <table id="calTable">
    </table>
</div>

<script>
    const table = document.getElementById('calTable');
    const monthSel = document.getElementById('monthSelect');
    const yearSel = document.getElementById('yearSelect');

    // 1. Setup Dropdowns
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const now = new Date();

    months.forEach((m, i) => {
        monthSel.innerHTML += `<option value="${i}" ${i === now.getMonth() ? 'selected' : ''}>${m}</option>`;
    });
    for(let y = 2025; y <= 2028; y++) {
        yearSel.innerHTML += `<option value="${y}" ${y === now.getFullYear() ? 'selected' : ''}>${y}</option>`;
    }

    // 2. MAIN RENDER LOGIC
    async function renderCalendar() {
        table.innerHTML = "<tr><td colspan='32'>Loading...</td></tr>";

        const month = parseInt(monthSel.value);
        const year = parseInt(yearSel.value);
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        try {
            const res = await fetch('calendarData');
            const rooms = await res.json();

            let html = "";

            // --- HEADER ROW (Days 1 to 31) ---
            html += "<thead><tr><th class='room-col' style='background:#2c3e50; color:white;'>Room</th>";
            for(let d=1; d<=daysInMonth; d++) {
                html += `<th>${d}</th>`;
            }
            html += "</tr></thead><tbody>";

            // --- ROOM ROWS ---
            let currentType = "";

            rooms.forEach(room => {
                // Add a Section Header if Room Type changes (e.g. "Single", "Double")
                if(room.type !== currentType) {
                    currentType = room.type;
                    html += `<tr><td class="type-header" colspan="${daysInMonth + 1}">${currentType.toUpperCase()} ROOMS</td></tr>`;
                }

                html += "<tr>";
                html += `<td class="room-col">Room ${room.number}</td>`;

                // Loop through every day of the month
                for(let d=1; d<=daysInMonth; d++) {
                    const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                    // Check Status
                    let statusClass = "free";
                    let tooltip = "Available";

                    // Highlight Weekends lightly
                    const dayOfWeek = new Date(year, month, d).getDay();
                    if(dayOfWeek === 0 || dayOfWeek === 6) statusClass = "weekend";

                    // Check if Booked
                    // We check if the current day 'd' is inside any reservation range
                    // NOTE: Check-out day is usually considered "Free" for the next guest to arrive
                    room.bookings.forEach(bk => {
                        const start = new Date(bk.start); // Check-in
                        const end = new Date(bk.end);     // Check-out
                        const current = new Date(year, month, d);

                        // If current date is >= start AND current date < end
                        if (current >= start && current < end) {
                            statusClass = "booked";
                            tooltip = `Guest: ${bk.guest}`;
                        }
                    });

                    // Render Cell
                    html += `<td class="${statusClass}" title="${tooltip}"></td>`;
                }
                html += "</tr>";
            });
            html += "</tbody>";
            table.innerHTML = html;

        } catch(e) {
            console.error(e);
            table.innerHTML = "<tr><td colspan='32'>Error loading data.</td></tr>";
        }
    }

    // Load on start
    renderCalendar();
</script>

</body>
</html>