<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

    body {
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      padding: 40px;
      color: white;
      min-height: 100vh;
    }

    .wrapper { max-width: 1300px; margin: 0 auto; }

    /* Header */
    .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px;
    }

    .header h2 { font-weight: 500; letter-spacing: 1px; }

    .logout {
      background: #e74c3c; padding: 8px 18px; border-radius: 8px; text-decoration: none;
      color: white; font-weight: 600; transition: 0.3s; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }

    .logout:hover { background: #c0392b; transform: translateY(-2px); }

    /* Tabs */
    .nav-tabs { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
    .tab-btn {
      background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2);
      padding: 10px 25px; border-radius: 30px; cursor: pointer; color: rgba(255,255,255,0.7);
      font-weight: 600; transition: 0.3s;
    }
    .tab-btn:hover { background: rgba(255,255,255,0.15); color: white; }
    .tab-btn.active {
      background: #3498db; color: white; border-color: #3498db; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
    }

    .section { display: none; }
    .section.active { display: block; animation: fadeIn 0.5s ease; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Grid & Cards */
    .dashboard-grid { display: flex; gap: 25px; flex-wrap: wrap; }
    .col-left { flex: 3; min-width: 300px; }
    .col-right { flex: 1; min-width: 250px; }

    .card {
      backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%);
      background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 25px; border-radius: 16px; margin-bottom: 25px; transition: 0.3s;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }
    .card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.3); }

    .card h3 {
      margin-bottom: 15px; font-weight: 400; color: #bdc3c7; font-size: 1.1em;
      text-transform: uppercase; letter-spacing: 1px;
    }

    .chart-box { height: 250px; }

    /* Tables */
    table { width:100%; border-collapse: collapse; margin-top:5px; }
    th { padding:12px; text-align:left; background: rgba(255,255,255,0.1); color:white; border-radius:6px; }
    td { padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.05); }

    .room-img { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; }

    /* Buttons */
    .btn-inv, .btn-del, .btn-add, .btn-edit {
      border:none; padding:6px 12px; border-radius:6px; cursor:pointer;
      font-weight:600; transition:0.3s; color:white; font-size:12px;
    }
    .btn-inv { background: linear-gradient(135deg, #3498db, #2980b9); }
    .btn-inv:hover { box-shadow: 0 0 10px rgba(52, 152, 219, 0.5); }

    .btn-del { background: linear-gradient(135deg, #e74c3c, #c0392b); }
    .btn-del:hover { box-shadow: 0 0 10px rgba(231, 76, 60, 0.5); }

    .btn-edit { background: linear-gradient(135deg, #f39c12, #d35400); }
    .btn-edit:hover { box-shadow: 0 0 10px rgba(243, 156, 18, 0.5); }

    .btn-add { background: linear-gradient(135deg, #27ae60, #2ecc71); width:100%; padding:12px; font-size:14px; margin-top:10px; }
    .btn-add:hover { box-shadow: 0 0 15px rgba(46, 204, 113, 0.4); }

    /* Badges */
    .role-badge { padding: 4px 10px; border-radius: 20px; font-size:11px; font-weight:bold; letter-spacing:0.5px; }
    .role-ADMIN { background: rgba(52,152,219,0.2); color:#3498db; border:1px solid #3498db; }
    .role-RECEPTIONIST { background: rgba(46,204,113,0.2); color:#2ecc71; border:1px solid #2ecc71; }

    /* Inputs */
    input, select, textarea {
      width:100%; padding:12px; margin-bottom:15px;
      border-radius:8px; border:1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.2); color:white; outline:none; font-size:14px;
    }
    input:focus, select:focus, textarea:focus { border-color: #3498db; background: rgba(0,0,0,0.4); }
    option { background: #2c3e50; color:white; }
    label { font-size:12px; color: rgba(255,255,255,0.6); margin-bottom:5px; display:block; }

    /* Modal */
    .modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;
    }
    .modal-content {
      background: linear-gradient(135deg, #1f303e, #2c3e50); padding:30px;
      border-radius:12px; width:450px; border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 15px 35px rgba(0,0,0,0.5);
    }

    @media(max-width:900px){
      body { padding:20px; }
      .dashboard-grid { flex-direction: column; }
      .col-left, .col-right { width: 100%; }
    }
  </style>
</head>
<body>

<div class="wrapper">
  <div class="header">
    <h2>Admin Control Center</h2>
    <a href="#" onclick="logout()" class="logout">Logout</a>
  </div>

  <div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('analytics')">Analytics & Invoices</button>
    <button class="tab-btn" onclick="switchTab('users')">User Management</button>
    <button class="tab-btn" onclick="switchTab('rooms')">Room Management</button>
  </div>

  <div id="analytics" class="section active">
    <div class="dashboard-grid">
      <div class="col-left">
        <div class="card">
          <h3>Revenue Overview</h3>
          <div id="barchart" class="chart-box">Loading Chart...</div>
        </div>
        <div class="card">
          <h3>Recent Bookings & Invoices</h3>
          <table>
            <thead>
            <tr><th>ID</th><th>Guest</th><th>Room</th><th>Dates</th><th>Action</th></tr>
            </thead>
            <tbody id="invBody"><tr><td colspan="5">Loading data...</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="col-right">
        <div class="card">
          <h3>Room Popularity</h3>
          <div id="piechart" style="height:200px;">Loading...</div>
        </div>

        <div class="card" style="border-top: 4px solid #e74c3c;">
          <h3>Add Expense</h3>
          <form onsubmit="addExpense(event)">
            <label>Category</label>
            <select id="exCat">
              <option>Utilities</option><option>Salaries</option>
              <option>Maintenance</option><option>Marketing</option><option>Other</option>
            </select>
            <label>Amount ($)</label>
            <input type="number" id="exAmount" step="0.01" required placeholder="0.00">
            <button type="submit" class="btn-del" style="width:100%; margin-top:10px; padding:12px;">Record Expense</button>
          </form>
        </div>

        <div class="card" style="border-top: 4px solid #2ecc71;">
          <h3>Net Profit</h3>
          <h1 id="profitDisplay" style="font-size:2.5em; margin:10px 0;">Loading...</h1>
          <small id="expenseDisplay" style="color: rgba(255,255,255,0.6);">Expenses: $0.00</small>
        </div>
      </div>
    </div>
  </div>

  <div id="users" class="section">
    <div class="dashboard-grid">
      <div class="col-right">
        <div class="card" style="border-top: 4px solid #3498db;">
          <h3>Add User</h3>
          <form onsubmit="addUser(event)">
            <label>Name</label><input type="text" id="uName" required placeholder="Full Name">
            <label>Email</label><input type="email" id="uEmail" required placeholder="user@oceanview.com">
            <button type="submit" class="btn-add">Create User</button>
          </form>
        </div>
      </div>
      <div class="col-left">
        <div class="card">
          <h3>System Users</h3>
          <table id="userTable">
            <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr></thead>
            <tbody id="userBody"><tr><td colspan="5">Loading users...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="rooms" class="section">
    <div class="dashboard-grid">
      <div class="col-right">
        <div class="card" style="border-top: 4px solid #f1c40f;">
          <h3>Add New Room</h3>
          <form id="addRoomForm" onsubmit="addRoom(event)">
            <label>Room Number</label><input type="text" id="rNum" required placeholder="e.g. 101">
            <label>Type</label>
            <select id="rType"><option>Single</option><option>Double</option><option>Suite</option></select>
            <label>Price Per Night ($)</label><input type="number" id="rPrice" step="0.01" required placeholder="0.00">
            <label>Upload PC Image (Optional)</label><input type="file" id="rImg" accept="image/*">
            <label>Description</label><textarea id="rDesc" rows="3" placeholder="Room details..."></textarea>
            <button type="submit" class="btn-add">Add Room</button>
          </form>
        </div>
      </div>
      <div class="col-left">
        <div class="card">
          <h3>Manage Rooms</h3>
          <table>
            <thead><tr><th>Pic</th><th>Room #</th><th>Type</th><th>Price</th><th>Action</th></tr></thead>
            <tbody id="roomBody"><tr><td colspan="5">Loading rooms...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <h3 style="margin-bottom:20px; color: white;">Edit Room Details</h3>
    <form id="editRoomForm" onsubmit="submitEditRoom(event)">
      <input type="hidden" id="editId">
      <label>Room Number</label><input type="text" id="editNum" required>
      <label>Type</label>
      <select id="editType"><option>Single</option><option>Double</option><option>Suite</option></select>
      <label>Price ($)</label><input type="number" id="editPrice" step="0.01" required>
      <label>Change Picture (Leave empty to keep old)</label><input type="file" id="editImg" accept="image/*">
      <label>Description</label><textarea id="editDesc" rows="3"></textarea>

      <div style="display:flex; gap:10px; margin-top: 15px;">
        <button type="submit" class="btn-add" style="margin-top:0;">Save Changes</button>
        <button type="button" class="btn-del" style="width:100%; margin-top:10px;" onclick="closeModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  let allRoomsData = [];

  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(loadAnalytics);

  // Load tables on startup
  loadUsers();

  function switchTab(tabId) {
    document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');

    // Lazy load rooms only when tab is clicked
    if(tabId === 'rooms') loadAdminRooms();
  }

  // --- 1. ANALYTICS ---
  async function loadAnalytics() {
    try {
      const res = await fetch('adminData');
      const data = await res.json();

      const darkOptions = {
        backgroundColor: 'transparent',
        legend: { textStyle: { color: '#ffffff' }, position: 'bottom' },
        titleTextStyle: { color: '#ffffff' },
        hAxis: { textStyle: { color: '#ffffff' }, gridlines: { color: 'rgba(255,255,255,0.1)' } },
        vAxis: { textStyle: { color: '#ffffff' }, gridlines: { color: 'rgba(255,255,255,0.1)' } },
        pieSliceBorderColor: 'transparent'
      };

      var pie = new google.visualization.DataTable();
      pie.addColumn('string', 'Type'); pie.addColumn('number', 'Count');
      data.pieData.forEach(d => pie.addRow([d.type, d.count]));
      const pieOptions = { ...darkOptions, pieHole:0.4, colors:['#3498db','#e74c3c','#f1c40f'] };
      new google.visualization.PieChart(document.getElementById('piechart')).draw(pie, pieOptions);

      var bar = new google.visualization.DataTable();
      bar.addColumn('string','Type'); bar.addColumn('number','Revenue');
      let totalRevenue = 0;
      data.barData.forEach(d=>{ bar.addRow([d.type,d.revenue]); totalRevenue+=d.revenue; });
      const barOptions = { ...darkOptions, legend:'none', colors:['#2ecc71'] };
      new google.visualization.ColumnChart(document.getElementById('barchart')).draw(bar, barOptions);

      const totalExpenses = data.totalExpenses || 0;
      const profit = totalRevenue - totalExpenses;
      document.getElementById('profitDisplay').innerText = "$"+profit.toFixed(2);
      document.getElementById('expenseDisplay').innerText = "Total Expenses: $"+totalExpenses.toFixed(2);
      document.getElementById('profitDisplay').style.color = profit>=0?'#2ecc71':'#e74c3c';

      const tbody = document.getElementById('invBody'); tbody.innerHTML='';
      if(data.invoices && data.invoices.length>0){
        data.invoices.forEach(i=>{
          tbody.innerHTML+=`<tr>
            <td>#${i.id}</td>
            <td>${i.customer}</td>
            <td>${i.room}</td>
            <td><small>${i.checkIn}<br>${i.checkOut}</small></td>
            <td><button class="btn-inv" onclick="printInv(${i.id}, '${i.customer}', '${i.room}', '${i.checkIn}', '${i.checkOut}', ${i.price})">Invoice</button></td>
          </tr>`;
        });
      } else { tbody.innerHTML='<tr><td colspan="5" style="color:rgba(255,255,255,0.5)">No bookings yet.</td></tr>'; }
    } catch(e){ console.error("Analytics Error:",e); }
  }

  async function addExpense(e){
    e.preventDefault();
    const params=new URLSearchParams();
    params.append('category',document.getElementById('exCat').value);
    params.append('amount',document.getElementById('exAmount').value);
    try{
      const res=await fetch('addExpense',{method:'POST',body:params});
      const json=await res.json();
      if(json.status==='success'){ alert("Expense Saved"); document.getElementById('exAmount').value=""; loadAnalytics(); }
      else alert("Error saving expense");
    }catch(e){ alert("Server Error"); }
  }

  // --- 2. USERS ---
  async function loadUsers() {
    const tbody=document.getElementById('userBody'); tbody.innerHTML='';
    try{
      const res=await fetch('userManagement'); if(!res.ok) throw new Error("API Error");
      const users=await res.json();
      users.forEach(u=>{
        const badgeClass=u.role==='ADMIN'?'role-ADMIN':'role-RECEPTIONIST';
        tbody.innerHTML+=`<tr>
          <td>#${u.id}</td>
          <td><strong>${u.name}</strong></td>
          <td>${u.email}</td>
          <td><span class="role-badge ${badgeClass}">${u.role}</span></td>
          <td><button class="btn-del" onclick="deleteUser(${u.id})">Delete</button></td>
        </tr>`;
      });
    }catch(e){ tbody.innerHTML='<tr><td colspan="5" style="color:#e74c3c">Error loading users</td></tr>'; }
  }

  async function addUser(e){
    e.preventDefault();
    const params=new URLSearchParams();
    params.append('name',document.getElementById('uName').value);
    params.append('email',document.getElementById('uEmail').value);
    try{
      const res=await fetch('register',{method:'POST',body:params});
      const json=await res.json();
      if(json.status==='success'){ alert("User Created! Password sent to email."); document.getElementById('uName').value=""; document.getElementById('uEmail').value=""; loadUsers(); }
      else alert("Error: "+json.message);
    }catch(e){ alert("Server Error"); }
  }

  async function deleteUser(id){
    if(!confirm("Delete this user?")) return;
    const params=new URLSearchParams(); params.append('action','delete'); params.append('id',id);
    await fetch('userManagement',{method:'POST',body:params}); loadUsers();
  }

  function printInv(id,name,room,inDate,outDate,price){
    const total=price;
    const url=`print_receipt.html?id=${id}&name=${encodeURIComponent(name)}&room=${encodeURIComponent(room)}&in=${inDate}&out=${outDate}&price=${price}&total=${total}`;
    window.open(url,'_blank');
  }

  // --- 3. ROOM MANAGEMENT ---
  async function loadAdminRooms() {
    const tbody = document.getElementById('roomBody');
    try {
      const res = await fetch('roomManagement');
      allRoomsData = await res.json();
      tbody.innerHTML = '';
      allRoomsData.forEach(r => {
        // ADDED THE DELETE BUTTON HERE
        tbody.innerHTML += `<tr>
          <td><img src="${r.image}" class="room-img" onerror="this.src='images/icon1.png'"></td>
          <td><strong>${r.number}</strong></td>
          <td>${r.type}</td>
          <td>$${r.price.toFixed(2)}</td>
          <td style="display:flex; gap:5px;">
            <button class="btn-edit" onclick="openEditModal(${r.id})">Edit</button>
            <button class="btn-del" onclick="deleteRoom(${r.id})">Delete</button>
          </td>
        </tr>`;
      });
    } catch(e) { tbody.innerHTML='<tr><td colspan="5">Error loading rooms</td></tr>'; }
  }

  async function addRoom(e) {
    e.preventDefault();
    const formData = new FormData();
    formData.append('action', 'add');
    formData.append('number', document.getElementById('rNum').value);
    formData.append('type', document.getElementById('rType').value);
    formData.append('price', document.getElementById('rPrice').value);
    formData.append('description', document.getElementById('rDesc').value);

    const fileInput = document.getElementById('rImg');
    if(fileInput.files.length > 0) {
      formData.append('image', fileInput.files[0]);
    }

    try {
      const res = await fetch('roomManagement', { method: 'POST', body: formData });
      const json = await res.json();
      if(json.status === 'success') {
        alert("Room added successfully!");
        document.getElementById('addRoomForm').reset();
        loadAdminRooms();
      } else alert("Error adding room");
    } catch(e) { alert("Server Error"); }
  }

  // NEW JS METHOD: Delete Room
  async function deleteRoom(id) {
    if(!confirm(`Are you sure you want to completely delete Room ID #${id}?`)) return;

    const formData = new FormData();
    formData.append('action', 'delete');
    formData.append('id', id);

    try {
      const res = await fetch('roomManagement', { method: 'POST', body: formData });
      const json = await res.json();
      if(json.status === 'success') {
        alert("Room deleted successfully!");
        loadAdminRooms();
      } else {
        alert(json.message || "Error deleting room");
      }
    } catch(e) { alert("Server Error"); }
  }

  // Edit Modal Functions
  function openEditModal(id) {
    const room = allRoomsData.find(r => r.id === id);
    if(!room) return;

    document.getElementById('editId').value = room.id;
    document.getElementById('editNum').value = room.number;
    document.getElementById('editType').value = room.type;
    document.getElementById('editPrice').value = room.price;
    document.getElementById('editDesc').value = room.description;
    document.getElementById('editImg').value = ""; // Clear file input

    document.getElementById('editModal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('editModal').style.display = 'none';
  }

  async function submitEditRoom(e) {
    e.preventDefault();
    const formData = new FormData();
    formData.append('action', 'edit');
    formData.append('id', document.getElementById('editId').value);
    formData.append('number', document.getElementById('editNum').value);
    formData.append('type', document.getElementById('editType').value);
    formData.append('price', document.getElementById('editPrice').value);
    formData.append('description', document.getElementById('editDesc').value);

    const fileInput = document.getElementById('editImg');
    if(fileInput.files.length > 0) {
      formData.append('image', fileInput.files[0]);
    }

    try {
      const res = await fetch('roomManagement', { method: 'POST', body: formData });
      const json = await res.json();
      if(json.status === 'success') {
        alert("Room updated successfully!");
        closeModal();
        loadAdminRooms();
      } else alert("Error updating room");
    } catch(e) { alert("Server Error"); }
  }

  async function logout(){ await fetch('logout'); window.location.href='login_app.html'; }
</script>
</body>
</html>