<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f7; padding: 20px; }
    .wrapper { max-width: 1200px; margin: 0 auto; }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    .tab-btn { background: none; border: none; font-size: 16px; padding: 10px 20px; cursor: pointer; color: #7f8c8d; font-weight: bold; }
    .tab-btn.active { color: #3498db; border-bottom: 3px solid #3498db; }
    .logout { background: #e74c3c; color: white; text-decoration: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; font-size: 14px; }

    .section { display: none; }
    .section.active { display: block; }

    .dashboard-grid { display: flex; gap: 20px; }
    .col-left { flex: 3; }
    .col-right { flex: 1; }

    .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .chart-box { height: 250px; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { background: #2c3e50; color: white; padding: 10px; text-align: left; }
    td { padding: 10px; border-bottom: 1px solid #eee; }

    .btn-inv { background: #8e44ad; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
    .btn-del { background: #c0392b; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
    .btn-add { background: #2980b9; color: white; padding: 10px; width: 100%; border: none; cursor: pointer; border-radius: 4px; margin-top: 10px;}

    .role-badge { padding: 3px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
    .role-ADMIN { background: #8e44ad; color: white; }
    .role-RECEPTIONIST { background: #27ae60; color: white; }

    input, select { width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
  </style>
</head>
<body>

<div class="wrapper">
  <div class="header">
    <h2 style="color: #2c3e50;">Admin Control Center</h2>
    <a href="#" onclick="logout()" class="logout">Logout</a>
  </div>

  <div class="nav-tabs">
    <button class="tab-btn active" onclick="switchTab('analytics')">ðŸ“Š Analytics & Invoices</button>
    <button class="tab-btn" onclick="switchTab('users')">ðŸ‘¥ User Management</button>
  </div>

  <!-- --- ANALYTICS SECTION --- -->
  <div id="analytics" class="section active">
    <div class="dashboard-grid">
      <!-- Left Column -->
      <div class="col-left">
        <!-- Revenue Overview -->
        <div class="card">
          <h3>Revenue Overview</h3>
          <div id="barchart" class="chart-box">Loading Chart...</div>
        </div>

        <!-- Recent Bookings / Invoices -->
        <div class="card">
          <h3>Recent Bookings & Invoices</h3>
          <table>
            <thead>
            <tr><th>ID</th><th>Guest</th><th>Room</th><th>Dates</th><th>Action</th></tr>
            </thead>
            <tbody id="invBody"><tr><td colspan="5">Loading data...</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Right Column -->
      <div class="col-right">
        <!-- Room Popularity Pie -->
        <div class="card">
          <h3>Room Popularity</h3>
          <div id="piechart" style="height: 200px;">Loading...</div>
        </div>

        <!-- Add Expense -->
        <div class="card" style="border-top: 4px solid #e74c3c;">
          <h3>ðŸ’¸ Add Expense</h3>
          <form onsubmit="addExpense(event)">
            <label>Category</label>
            <select id="exCat">
              <option>Utilities</option>
              <option>Salaries</option>
              <option>Maintenance</option>
              <option>Marketing</option>
              <option>Other</option>
            </select>

            <label>Amount ($)</label>
            <input type="number" id="exAmount" step="0.01" required>

            <button type="submit" class="btn-del" style="width:100%">Record Expense</button>
          </form>
        </div>

        <!-- Net Profit -->
        <div class="card" style="background: #2c3e50; color: white;">
          <h3>ðŸ’° Net Profit</h3>
          <h1 id="profitDisplay">Loading...</h1>
          <small id="expenseDisplay">Expenses: $0.00</small>
        </div>
      </div>
    </div>
  </div>

  <!-- --- USER MANAGEMENT SECTION --- -->
  <div id="users" class="section">
    <div class="dashboard-grid">
      <!-- Right Column -->
      <div class="col-right">
        <div class="card" style="border-top: 4px solid #2980b9;">
          <h3>âž• Add User</h3>
          <form onsubmit="addUser(event)">
            <label>Name</label><input type="text" id="uName" required>
            <label>Email</label><input type="email" id="uEmail" required>
            <button type="submit" class="btn-add">Create User</button>
          </form>
        </div>
      </div>

      <!-- Left Column -->
      <div class="col-left">
        <div class="card">
          <h3>System Users</h3>
          <table id="userTable">
            <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr></thead>
            <tbody id="userBody"><tr><td colspan="5">Loading users...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(loadAnalytics);
  loadUsers();

  function switchTab(tabId) {
    document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
  }

  // --- LOAD ANALYTICS ---
  async function loadAnalytics() {
    try {
      const res = await fetch('adminData');
      const data = await res.json();

      // Pie Chart
      var pie = new google.visualization.DataTable();
      pie.addColumn('string', 'Type'); pie.addColumn('number', 'Count');
      data.pieData.forEach(d => pie.addRow([d.type, d.count]));
      new google.visualization.PieChart(document.getElementById('piechart'))
              .draw(pie, {legend: 'bottom', pieHole: 0.4});

      // Bar Chart
      var bar = new google.visualization.DataTable();
      bar.addColumn('string', 'Type'); bar.addColumn('number', 'Revenue');
      let totalRevenue = 0;
      data.barData.forEach(d => { bar.addRow([d.type, d.revenue]); totalRevenue += d.revenue; });
      new google.visualization.ColumnChart(document.getElementById('barchart'))
              .draw(bar, {legend: 'none', colors: ['#3498db']});

      // Profit Calculation
      const totalExpenses = data.totalExpenses || 0;
      const profit = totalRevenue - totalExpenses;
      document.getElementById('profitDisplay').innerText = "$" + profit.toFixed(2);
      document.getElementById('expenseDisplay').innerText = "Total Expenses: $" + totalExpenses.toFixed(2);
      document.getElementById('profitDisplay').style.color = profit >= 0 ? '#2ecc71' : '#e74c3c';

      // Invoices Table
      const tbody = document.getElementById('invBody');
      tbody.innerHTML = '';
      if (data.invoices && data.invoices.length > 0) {
        data.invoices.forEach(i => {
          tbody.innerHTML += `
            <tr>
              <td>#${i.id}</td>
              <td>${i.customer}</td>
              <td>${i.room}</td>
              <td><small>${i.checkIn}<br>${i.checkOut}</small></td>
              <td>
                <button class="btn-inv"
                  onclick="printInv(${i.id}, '${i.customer}', '${i.room}', '${i.checkIn}', '${i.checkOut}', ${i.price})">
                  ðŸ“„ Invoice
                </button>
              </td>
            </tr>`;
        });
      } else { tbody.innerHTML = '<tr><td colspan="5">No bookings yet.</td></tr>'; }

    } catch(e) { console.error("Analytics Error:", e); }
  }

  // --- ADD EXPENSE ---
  async function addExpense(e) {
    e.preventDefault();
    const params = new URLSearchParams();
    params.append('category', document.getElementById('exCat').value);
    params.append('amount', document.getElementById('exAmount').value);

    try {
      const res = await fetch('addExpense', { method: 'POST', body: params });
      const json = await res.json();
      if(json.status === 'success') {
        alert("âœ… Expense Saved!");
        document.getElementById('exAmount').value = "";
        loadAnalytics();
      } else { alert("Error saving expense"); }
    } catch(e) { alert("Server Error"); }
  }

  // --- USERS MANAGEMENT ---
  async function loadUsers() {
    const tbody = document.getElementById('userBody');
    try {
      const res = await fetch('userManagement');
      if(!res.ok) throw new Error("API Error");
      const users = await res.json();
      tbody.innerHTML = '';
      users.forEach(u => {
        const badgeClass = u.role === 'ADMIN' ? 'role-ADMIN' : 'role-RECEPTIONIST';
        tbody.innerHTML += `
          <tr>
            <td>#${u.id}</td>
            <td><strong>${u.name}</strong></td>
            <td>${u.email}</td>
            <td><span class="role-badge ${badgeClass}">${u.role}</span></td>
            <td><button class="btn-del" onclick="deleteUser(${u.id})">ðŸ—‘ Delete</button></td>
          </tr>`;
      });
    } catch(e) { tbody.innerHTML = '<tr><td colspan="5" style="color:red">Error loading users</td></tr>'; }
  }

  async function addUser(e) {
    e.preventDefault();
    const params = new URLSearchParams();
    params.append('name', document.getElementById('uName').value);
    params.append('email', document.getElementById('uEmail').value);

    try {
      const res = await fetch('register', { method: 'POST', body: params });
      const json = await res.json();
      if(json.status === 'success') { alert("âœ… User Created!"); loadUsers(); }
      else alert("Error: " + json.message);
    } catch(e) { alert("Server Error"); }
  }

  async function deleteUser(id) {
    if(!confirm("Delete this user?")) return;
    const params = new URLSearchParams();
    params.append('action','delete'); params.append('id',id);
    await fetch('userManagement',{ method:'POST', body:params });
    loadUsers();
  }

  function printInv(id,name,room,inDate,outDate,price){
    const total = price;
    const url = `print_receipt.html?id=${id}&name=${encodeURIComponent(name)}&room=${encodeURIComponent(room)}&in=${inDate}&out=${outDate}&price=${price}&total=${total}`;
    window.open(url,'_blank');
  }

  async function logout() {
    await fetch('logout');
    window.location.href = 'login_app.html';
  }

</script>
</body>
</html>
